generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model School {
  id               String            @id @default(uuid())
  name             String
  curriculumId     String
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  assessments      Assessment[]
  classes          Class[]
  classEnrollments ClassEnrollment[]
  curricula        Curriculum[]      @relation("SchoolCurriculum")
  feedbacks        Feedback[]
  grades           Grade[]
  gradeSubjects    GradeSubject[]
  lessons          Lesson[]
  curriculum       Curriculum        @relation("SchoolPrimaryCurriculum", fields: [curriculumId], references: [id])
  subjects         Subject[]
  terms            Term[]
  topics           Topic[]
  users            Profile[]
}

model Profile {
  id                  String            @id @default(uuid())
  email               String            @unique
  name                String?
  role                Role
  schoolId            String?
  curriculumId        String
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  assessments         Assessment[]      @relation("StudentAssessments")
  taughtClasses       Class[]           @relation("TeacherClasses")
  classEnrollments    ClassEnrollment[]
  ownedGradeSubjects  GradeSubject[]    @relation("ProfileToGradeSubject")
  curriculum          Curriculum        @relation(fields: [curriculumId], references: [id])
  school              School?           @relation(fields: [schoolId], references: [id])
  gradeSubjectsTaught GradeSubject[]    @relation("TeacherGradeSubjects")
  selectedSubjects    GradeSubject[]    @relation("UserSelectedSubjects")

  @@index([schoolId])
  @@index([curriculumId])
  @@map("profiles")
}

model Curriculum {
  id             String    @id @default(uuid())
  name           String
  schoolId       String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  subjectLabel   String    @default("Subject")
  termLabel      String    @default("Term")
  yearLabel      String    @default("Year")
  school         School?   @relation("SchoolCurriculum", fields: [schoolId], references: [id])
  grades         Grade[]
  primarySchools School[]  @relation("SchoolPrimaryCurriculum")
  subjects       Subject[]
  users          Profile[]

  @@index([schoolId])
}

model Grade {
  id            String         @id @default(uuid())
  level         Int
  slug          String
  displayName   String
  shortName     String?
  curriculumId  String
  schoolId      String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  classes       Class[]
  curriculum    Curriculum     @relation(fields: [curriculumId], references: [id])
  school        School?        @relation(fields: [schoolId], references: [id])
  gradeSubjects GradeSubject[]
  terms         Term[]

  @@unique([curriculumId, level])
  @@index([schoolId])
  @@index([curriculumId])
}

model Term {
  id          String   @id @default(uuid())
  index       Int
  displayName String
  gradeId     String
  schoolId    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  grade       Grade    @relation(fields: [gradeId], references: [id])
  school      School?  @relation(fields: [schoolId], references: [id])
  topics      Topic[]

  @@unique([gradeId, index])
  @@index([schoolId])
}

model Subject {
  id            String         @id @default(uuid())
  name          String
  curriculumId  String
  schoolId      String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  gradeSubjects GradeSubject[]
  curriculum    Curriculum     @relation(fields: [curriculumId], references: [id])
  school        School?        @relation(fields: [schoolId], references: [id])

  @@index([schoolId])
  @@index([curriculumId])
}

model Topic {
  id             String       @id @default(uuid())
  title          String
  gradeSubjectId String
  termId         String
  schoolId       String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  description    String?
  weekNumber     Int?
  assessments    Assessment[]
  lessons        Lesson?
  gradeSubject   GradeSubject @relation(fields: [gradeSubjectId], references: [id])
  school         School?      @relation(fields: [schoolId], references: [id])
  term           Term         @relation(fields: [termId], references: [id])

  @@index([schoolId])
}

model Class {
  id          String            @id @default(uuid())
  name        String
  gradeId     String
  schoolId    String?
  teacherId   String
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  grade       Grade             @relation(fields: [gradeId], references: [id])
  school      School?           @relation(fields: [schoolId], references: [id])
  teacher     Profile           @relation("TeacherClasses", fields: [teacherId], references: [id])
  enrollments ClassEnrollment[]

  @@index([schoolId])
}

model ClassEnrollment {
  id             String       @id @default(uuid())
  classId        String?
  studentId      String
  schoolId       String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  gradeSubjectId String
  class          Class?       @relation(fields: [classId], references: [id])
  gradeSubject   GradeSubject @relation(fields: [gradeSubjectId], references: [id])
  school         School?      @relation(fields: [schoolId], references: [id])
  student        Profile      @relation(fields: [studentId], references: [id])
}

model Assessment {
  id             String         @id @default(uuid())
  type           AssessmentType
  studentId      String
  gradeSubjectId String
  topicId        String?
  schoolId       String?
  score          Float?
  maxScore       Float?
  comments       String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  gradeSubject   GradeSubject   @relation(fields: [gradeSubjectId], references: [id])
  school         School?        @relation(fields: [schoolId], references: [id])
  student        Profile        @relation("StudentAssessments", fields: [studentId], references: [id])
  topic          Topic?         @relation(fields: [topicId], references: [id])
  feedbacks      Feedback[]

  @@index([schoolId])
}

model Lesson {
  id          String   @id @default(uuid())
  title       String
  content     String?
  topicId     String   @unique
  schoolId    String?
  aiContent   Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  videoScript String?
  school      School?  @relation(fields: [schoolId], references: [id])
  topic       Topic    @relation(fields: [topicId], references: [id])
  quiz        Quiz?
}

model Quiz {
  id        String     @id @default(uuid())
  lessonId  String     @unique
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  questions Question[]
  lesson    Lesson     @relation(fields: [lessonId], references: [id], onDelete: Cascade)
}

model Question {
  id            String  @id @default(uuid())
  quizId        String
  text          String
  options       Json
  correctAnswer String
  explanation   String?
  quiz          Quiz    @relation(fields: [quizId], references: [id], onDelete: Cascade)
}

model Feedback {
  id           String     @id @default(uuid())
  assessmentId String
  schoolId     String?
  message      String?
  whatsappSid  String?
  sentAt       DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  assessment   Assessment @relation(fields: [assessmentId], references: [id])
  school       School?    @relation(fields: [schoolId], references: [id])

  @@index([schoolId])
}

model GradeSubject {
  id              String            @id @default(uuid())
  gradeId         String
  subjectId       String
  schoolId        String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  profileId       String?
  assessments     Assessment[]
  enrollments     ClassEnrollment[]
  grade           Grade             @relation(fields: [gradeId], references: [id])
  profile         Profile?          @relation("ProfileToGradeSubject", fields: [profileId], references: [id])
  school          School?           @relation(fields: [schoolId], references: [id])
  subject         Subject           @relation(fields: [subjectId], references: [id])
  topics          Topic[]
  teachers        Profile[]         @relation("TeacherGradeSubjects")
  selectedByUsers Profile[]         @relation("UserSelectedSubjects")

  @@unique([gradeId, subjectId])
}

enum Role {
  SUPER_ADMIN
  SCHOOL_ADMIN
  TEACHER
  STUDENT
  PARENT
  INDIVIDUAL_LEARNER
}

enum AssessmentType {
  TOPIC_BASED
  WEEKLY
  TERMLY
  YEARLY
}
