// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init
generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}
datasource db {
  provider = "postgresql"
}
// ---------------- Enums ----------------

enum Role {
  SUPER_ADMIN
  SCHOOL_ADMIN
  TEACHER
  STUDENT
  PARENT
  INDIVIDUAL_LEARNER
}

enum AssessmentType {
  TOPIC_BASED
  WEEKLY
  TERMLY
  YEARLY
}

// ---------------- Core Tenancy Models ----------------

model School {
  id           String     @id @default(uuid())
  name         String
  curriculumId String
  curriculum   Curriculum @relation("SchoolPrimaryCurriculum", fields: [curriculumId], references: [id])

  users     Profile[]
  classes   Class[]
  curricula Curriculum[] @relation("SchoolCurriculum")

  grades           Grade[]
  terms            Term[]
  subjects         Subject[]
  topics           Topic[]
  classEnrollments ClassEnrollment[]
  assessments      Assessment[]
  lessons          Lesson[]
  feedbacks        Feedback[]
  gradeSubjects    GradeSubject[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Profile {
  id    String  @id @default(uuid())
  email String  @unique
  name  String?
  role  Role

  // Tenancy
  schoolId String?
  school   School? @relation(fields: [schoolId], references: [id])

  // Every user has a curriculum
  curriculumId String
  curriculum   Curriculum @relation(fields: [curriculumId], references: [id])

  // Relations
  taughtClasses       Class[]        @relation("TeacherClasses")
  assessments         Assessment[]   @relation("StudentAssessments")
  gradeSubjectsTaught GradeSubject[] @relation("TeacherGradeSubjects")
  classEnrollments    ClassEnrollment[]

  // Dynamic subject selections (many-to-many with GradeSubject)
  selectedSubjects GradeSubject[] @relation("UserSelectedSubjects")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId])
  @@index([curriculumId])
  @@map("profiles")
}

// ---------------- Curriculum Hierarchy ----------------

model Curriculum {
  id   String @id @default(uuid())
  name String // e.g., "British National"

  // Magic labels: naming per country/curriculum
  yearLabel    String @default("Year")    // "Year", "Grade", or "Class"
  termLabel    String @default("Term")    // "Term", "Semester", or "Quarter"
  subjectLabel String @default("Subject") // "Subject" or "Course"

  // Optional: which school is using this curriculum as tenant-scoped copy
  schoolId String?
  school   School? @relation("SchoolCurriculum", fields: [schoolId], references: [id])

  grades         Grade[]
  subjects       Subject[]
  users          Profile[]
  primarySchools School[]  @relation("SchoolPrimaryCurriculum")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId])
}

model Grade {
  id    String @id @default(uuid())
  // Structural / canonical level (curriculum-agnostic)
  level Int // e.g. 1, 2, 3...
  slug  String // e.g. "grade-1", "year-1", "primary-1"

  // Curriculum-specific display naming
  displayName String // e.g. "Grade 1", "Year 1", "Primary 1"
  shortName   String? // e.g. "G1", "Y1"

  curriculumId String
  curriculum   Curriculum @relation(fields: [curriculumId], references: [id])

  schoolId String?
  school   School? @relation(fields: [schoolId], references: [id])

  terms         Term[]
  classes       Class[]
  gradeSubjects GradeSubject[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([curriculumId, level])
  @@index([schoolId])
  @@index([curriculumId])
}

model Term {
  id    String @id @default(uuid())
  // Structural index within a grade
  index Int // e.g. 1, 2, 3...

  // Curriculum-specific display naming
  displayName String // e.g. "Term 1", "Semester 1", "Trimester 1"

  gradeId String
  grade   Grade  @relation(fields: [gradeId], references: [id])

  schoolId String?
  school   School? @relation(fields: [schoolId], references: [id])

  topics Topic[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([gradeId, index])
  @@index([schoolId])
}

model Subject {
  id   String @id @default(uuid())
  name String

  curriculumId String
  curriculum   Curriculum @relation(fields: [curriculumId], references: [id])

  schoolId String?
  school   School? @relation(fields: [schoolId], references: [id])

  gradeSubjects GradeSubject[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId])
  @@index([curriculumId])
}

model Topic {
  id    String @id @default(uuid())
  title String

  description  String? 
  weekNumber   Int?
   
  gradeSubjectId String
  gradeSubject   GradeSubject @relation(fields: [gradeSubjectId], references: [id])

  termId String
  term   Term   @relation(fields: [termId], references: [id])

  schoolId String?
  school   School? @relation(fields: [schoolId], references: [id])

  lessons     Lesson[]
  assessments Assessment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId])
}

// ---------------- Classroom & Teaching ----------------

model Class {
  id   String @id @default(uuid())
  name String

  gradeId String
  grade   Grade  @relation(fields: [gradeId], references: [id])

  schoolId String?
  school   School? @relation(fields: [schoolId], references: [id])

  teacherId String
  teacher   Profile   @relation("TeacherClasses", fields: [teacherId], references: [id])

  // Optional: membership through join table
  enrollments ClassEnrollment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId])
}

model ClassEnrollment {
  id        String @id @default(uuid())
  classId   String
  studentId String

  class   Class @relation(fields: [classId], references: [id])
  student Profile  @relation(fields: [studentId], references: [id])

  schoolId String?
  school   School? @relation(fields: [schoolId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId])
}

// ---------------- Assessment System ----------------

model Assessment {
  id   String         @id @default(uuid())
  type AssessmentType

  // Required: the student being assessed
  studentId String
  student   Profile   @relation("StudentAssessments", fields: [studentId], references: [id])

  // Links to the specific subject taught in a grade
  gradeSubjectId String
  gradeSubject   GradeSubject @relation(fields: [gradeSubjectId], references: [id])

  // Optional: topic-level assessment within that GradeSubject
  topicId String?
  topic   Topic?  @relation(fields: [topicId], references: [id])

  schoolId String?
  school   School? @relation(fields: [schoolId], references: [id])

  score    Float?
  maxScore Float?
  comments String?

  feedbacks Feedback[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId])
}

// ---------------- AI & Integration ----------------

model Lesson {
  id          String   @id @default(uuid())
  title       String
  content     String?  @db.Text // The Markdown Explanation
  videoScript String?  @db.Text // The Teacher's Script
 
  topicId     String   @unique
  topic       Topic    @relation(fields: [topicId], references: [id])
 
  schoolId    String?
  school      School?  @relation(fields: [schoolId], references: [id])

  // NEW: Link to the Quiz
  quiz        Quiz?

  aiContent   Json?    // We keep this as a backup of the raw AI response
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Quiz {
  id        String     @id @default(uuid())
  lessonId  String     @unique
  lesson    Lesson     @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  questions Question[]
 
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model Question {
  id            String   @id @default(uuid())
  quizId        String
  quiz          Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
 
  text          String   @db.Text
  options       Json     // Stored as ["Option A", "Option B", etc.]
  correctAnswer String
  explanation   String?  @db.Text // Why this answer is correct
}

model Feedback {
  id           String     @id @default(uuid())
  assessmentId String
  assessment   Assessment @relation(fields: [assessmentId], references: [id])

  schoolId String?
  school   School? @relation(fields: [schoolId], references: [id])

  message String?

  // WhatsApp tracking
  whatsappSid String?
  sentAt      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId])
}

// ---------------- Grade-Subject Architecture ----------------

model GradeSubject {
  id String @id @default(uuid())

  gradeId String
  grade   Grade  @relation(fields: [gradeId], references: [id])

  subjectId String
  subject   Subject @relation(fields: [subjectId], references: [id])

  // Teacher responsible for this subject in this grade (usually across all terms)
  teacherId String?
  teacher   Profile?   @relation("TeacherGradeSubjects", fields: [teacherId], references: [id])

  schoolId String?
  school   School? @relation(fields: [schoolId], references: [id])

  topics      Topic[]
  assessments Assessment[]

  // Users (teachers or students) who have selected this subject
  selectedByUsers Profile[] @relation("UserSelectedSubjects")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([gradeId, subjectId])
  @@index([schoolId])
}
